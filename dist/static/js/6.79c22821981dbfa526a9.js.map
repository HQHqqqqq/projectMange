{"version":3,"sources":["webpack:///src/components/ContractMilestone/ContractMilestone.vue","webpack:///./src/components/ContractMilestone/ContractMilestone.vue?6771","webpack:///./src/components/ContractMilestone/ContractMilestone.vue"],"names":["ContractMilestone","name","components","GenerateForm","beforeRouteLeave","to","from","next","this","fileStatus","window","confirm","destroyed","onbeforeunload","created","mounted","_this","bus","$on","item","length","e","event","returnValue","data","currentProgress","jsonData","list","type","icon","isShow","tabs","options","defaultValue","width","placeholder","disabled","clearable","remote","remoteOptions","url_a","url_b","url_c","url_d","props","value","label","children","remoteFunc","key","model","rules","config","labelWidth","labelPosition","size","editData","remoteFuncs","methods","handleSubmit","_this2","$refs","generateForm","getData","then","json","localStorage","getItem","tableData","JSON","parse","updateData","saveReviewlog","catch","milestones","forEach","hash","projectMilestoneId","expectedBeginTime","expectedEndTime","workHours","currentProblems","accumulatedProgress","status","date","Date","year","getFullYear","month","getMonth","toString","day","getDate","dateTime","beginDate","delayDays","deliverable","del","ha","deliverableId","deliverableName","fileName","filePath","description","push","Object","api","res","code","alert","$emit","success","err","getCurrentProgress","arr","i","changeStatus","a","weight","Math","round","ContractMilestone_ContractMilestone","render","_h","$createElement","_c","_self","attrs","span","ref","staticRenderFns","Component","__webpack_require__","normalizeComponent","__webpack_exports__"],"mappings":"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","file":"static/js/6.79c22821981dbfa526a9.js","sourcesContent":["<template>\r\n  <!--合同里程碑页面-->\r\n  <!--<el-col :span=\"23\" class=\"main projectview\">-->\r\n  <el-col :span=\"24\">\r\n    <generate-form :data=\"jsonData\" :remote=\"remoteFuncs\" :value=\"editData\" ref=\"generateForm\"></generate-form>\r\n  </el-col>\r\n</template>\r\n\r\n<script>\r\nimport GenerateForm from \"@/components/CreateForm/GenerateForm\";\r\nimport { serverPostHttpMethod } from \"../../api/api.js\"; //\r\nimport Bus from \"../../bus\";\r\n\r\nexport default {\r\n  name: \"ContractMilestone\",\r\n  components: {\r\n    GenerateForm\r\n  },\r\n\r\n  //离开当前页面提示\r\n  beforeRouteLeave(to, from, next) {\r\n    if (!this.fileStatus) {\r\n      next();\r\n    } else {\r\n      const answer = window.confirm(\r\n        \"系统可能不会保存您所做的更改，确定要离开吗?\"\r\n      );\r\n      if (answer) {\r\n        next();\r\n      } else {\r\n        next(false);\r\n      }\r\n    }\r\n  },\r\n\r\n  destroyed() {\r\n    window.onbeforeunload = null;\r\n  },\r\n  created() {},\r\n\r\n  mounted() {\r\n    Bus.$on(\"fileUploadFiles\", item => {\r\n      if (item && item.length > 0) {\r\n        console.log(item);\r\n        this.fileStatus = true;\r\n\r\n        //刷新页面验证\r\n        window.onbeforeunload = function(e) {\r\n          e = e || window.event;\r\n          // 兼容IE8和Firefox 4之前的版本\r\n          if (e) {\r\n            e.returnValue = \"关闭提示\";\r\n          }\r\n          // Chrome, Safari, Firefox 4+, Opera 12+ , IE 9+\r\n          return \"关闭提示\";\r\n        };\r\n      } else {\r\n        this.fileStatus = false;\r\n        window.onbeforeunload = null; //取消刷新页面验证\r\n      }\r\n    });\r\n  },\r\n\r\n  data() {\r\n    return {\r\n      fileStatus: false, //文件是否全部上传完的状态 true未全部上传  false已全部上传完\r\n      currentProgress: 0,\r\n      jsonData: {\r\n        // \"list\": [\r\n        //   {\r\n        //     \"type\": \"milepost\",\r\n        //     \"name\": \"\",\r\n        //     \"icon\": \"icon-select\",\r\n        //     \"isShow\": \"true\",\r\n        //     \"url\": \"\",\r\n        //     \"options\": {\r\n        //       \"defaultValue\": [],\r\n        //       \"disabled\": false,\r\n        //       \"clearable\": false,\r\n        //       \"required\": false,\r\n        //       \"width\": \"\",\r\n        //       \"remote\": false,\r\n        //       \"filterable\": false,\r\n        //       \"remoteOptions\": [],\r\n        //       \"url_a\": \"\",\r\n        //       \"url_b\": \"\",\r\n        //       \"props\": {\"value\": \"value\", \"label\": \"label\"},\r\n        //       \"remoteFunc\": \"func_1560127205000_9527\"\r\n        //     },\r\n        //     \"config\": {\"labelPosition\": \"left\"},\r\n        //     \"key\": \"1560127205000_9527\",\r\n        //     \"model\": \"milepost_1560127205000_9527\",\r\n        //     \"rules\": []\r\n        //   }], \"config\": {\"labelWidth\": 100, \"labelPosition\": \"top\", \"size\": \"small\"}\r\n\r\n        list: [\r\n          {\r\n            type: \"tabs\",\r\n            name: \"\",\r\n            icon: \"icon-jilianxuanze\",\r\n            isShow: \"true\",\r\n            tabs: [\r\n              // {\r\n              //   \"name\": \"里程碑Review\"\r\n              // },\r\n              {\r\n                name: \"回款里程碑计划\"\r\n              }\r\n              // {\r\n              //   \"name\": \"回款条件Review\"\r\n              // }\r\n            ],\r\n            options: {\r\n              defaultValue: [],\r\n              width: \"\",\r\n              placeholder: \"\",\r\n              disabled: false,\r\n              clearable: false,\r\n              remote: true,\r\n              remoteOptions: [],\r\n              url_a: \"\",\r\n              url_b: \"\",\r\n              url_c: \"\",\r\n              url_d: \"\",\r\n              props: {\r\n                value: \"value\",\r\n                label: \"label\",\r\n                children: \"children\"\r\n              },\r\n              remoteFunc: \"func_1563958033000_83495\"\r\n            },\r\n            key: \"1563958033000_83495\",\r\n            model: \"tabs_1563958033000_83495\",\r\n            rules: []\r\n          }\r\n        ],\r\n        config: {\r\n          labelWidth: 100,\r\n          labelPosition: \"top\",\r\n          size: \"small\"\r\n        }\r\n      },\r\n      editData: {},\r\n      remoteFuncs: {}\r\n    };\r\n  },\r\n  methods: {\r\n    handleSubmit() {\r\n      this.$refs.generateForm\r\n        .getData()\r\n        .then(data => {\r\n          // 获取全局数据\r\n          var json = localStorage.getItem(\"MilepostParams\");\r\n          var tableData = JSON.parse(json);\r\n          console.log(tableData);\r\n          // 更新数据\r\n          this.updateData(tableData);\r\n          this.saveReviewlog(tableData); //保存review记录\r\n\r\n          // 数据校验成功\r\n          // data 为获取的表单数据\r\n        })\r\n        .catch(e => {\r\n          // 数据校验失败\r\n        });\r\n    },\r\n\r\n    updateData(tableData) {\r\n      console.log(\"====更新里程碑信息=====\");\r\n      var url = \"/sgpm/rest/api/server/pm/project/milestones\";\r\n      var data = {};\r\n      var milestones = [];\r\n      tableData.forEach(item => {\r\n        var hash = {};\r\n        hash[\"id\"] = item.projectMilestoneId; //里程碑id\r\n        hash[\"estimatedStartDate\"] = item.expectedBeginTime; //预计开始时间\r\n        hash[\"estimatedFinishDate\"] = item.expectedEndTime; //预计结束时间\r\n        // hash[\"finishDate\"] = item.actualEndTime;             //实际完成时间\r\n        hash[\"estimatedWorkingHours\"] = item.workHours; //预计工时\r\n        // hash[\"delayDays\"] = item.delayDays;                 //延期天数\r\n\r\n        hash[\"currentProblems\"] = item.currentProblems; //当前问题\r\n        hash[\"accumulatedProgress\"] = item.accumulatedProgress; //累计进度\r\n        hash[\"status\"] = item.status; //里程碑中 status: 0 未完成  1 进行中  2 已完成\r\n\r\n        // 选择完成时 添加实际完成时间\r\n        if (item.status == 2) {\r\n          var date = new Date();\r\n          var year = date.getFullYear();\r\n          var month = (date.getMonth() + 1).toString();\r\n          var day = date.getDate().toString();\r\n          if (month.length == 1) {\r\n            month = \"0\" + month;\r\n          }\r\n          if (day.length == 1) {\r\n            day = \"0\" + day;\r\n          }\r\n          var dateTime = year + \"-\" + month + \"-\" + day;\r\n          hash[\"finishDate\"] = dateTime; //实际完成时间\r\n\r\n          // 根据实际完成时间计算延期天数\r\n          var beginDate = new Date(Date.parse(item.expectedEndTime));\r\n          var endDate = new Date(Date.parse(dateTime));\r\n          var delayDays = (endDate - beginDate) / (1000 * 24 * 3600); //获取天数\r\n          hash[\"delayDays\"] = delayDays; //延期天数\r\n        }\r\n        //交付物\r\n        var deliverable = [];\r\n        item.deliverable.forEach(del => {\r\n          var ha = {};\r\n          ha[\"id\"] = del.deliverableId; //交付物id\r\n          ha[\"deliverableName\"] = del.deliverableName;\r\n          ha[\"fileName\"] = del.fileName;\r\n          ha[\"filePath\"] = del.filePath;\r\n          ha[\"description\"] = del.description;\r\n          ha[\"status\"] = del.status; //erp中交付物状态 1未上传 2待审核   3审核通过   4驳回\r\n          deliverable.push(ha);\r\n        });\r\n        hash[\"deliverable\"] = deliverable;\r\n        milestones.push(hash);\r\n      });\r\n      data[\"milestones\"] = milestones; //里程碑信息\r\n      serverPostHttpMethod(url, data)\r\n        .then(res => {\r\n          console.log(res.data);\r\n          if (res.data.code == 200) {\r\n            alert(\"保存成功\");\r\n\r\n            Bus.$emit(\"MilePostSave\", { code: 200, success: true });\r\n          } else {\r\n            alert(\"保存失败\");\r\n          }\r\n        })\r\n        .catch(err => {\r\n          console.log(err);\r\n        });\r\n    },\r\n\r\n    //保存review记录\r\n    saveReviewlog(tableData) {\r\n      console.log(\"=====保存review记录======\");\r\n      this.getCurrentProgress(tableData);\r\n      console.log(\"aaa:\" + this.currentProgress);\r\n      console.log(\"aaa111:\" + this.currentProgress / 100);\r\n      var arr = []; //记录所有review操作的数据\r\n      for (var i = 0; i < tableData.length; i++) {\r\n        var item = tableData[i];\r\n        if (item.changeStatus) {\r\n          arr.push(item);\r\n        }\r\n      }\r\n      if (arr.length > 0) {\r\n        var item = arr[arr.length - 1];\r\n        var url = \"/sgpm/rest/api/server/pm/project/reviewlog\";\r\n        var data = {};\r\n        data[\"percentageComplete\"] = this.currentProgress / 100; //当前进度\r\n        data[\"currentStatus\"] = item.status;\r\n        data[\"progressProblems\"] = item.currentProblems;\r\n        data[\"projectMilestoneId\"] = item.projectMilestoneId;\r\n        serverPostHttpMethod(url, data)\r\n          .then(res => {\r\n            console.log(res.data);\r\n            if (res.data.code == 200) {\r\n            } else {\r\n              alert(\"保存失败\");\r\n            }\r\n          })\r\n          .catch(err => {\r\n            console.log(err);\r\n          });\r\n      }\r\n    },\r\n\r\n    //计算当前进度\r\n    getCurrentProgress(tableData) {\r\n      var a = 0;\r\n      tableData.forEach(item => {\r\n        a += item.weight * item.accumulatedProgress;\r\n      });\r\n      console.log(\"a:\" + a / 100);\r\n      this.currentProgress = Math.round(a / 100); //四舍五入\r\n    }\r\n  }\r\n};\r\n</script>\r\n\n\n\n// WEBPACK FOOTER //\n// src/components/ContractMilestone/ContractMilestone.vue","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('el-col',{attrs:{\"span\":24}},[_c('generate-form',{ref:\"generateForm\",attrs:{\"data\":_vm.jsonData,\"remote\":_vm.remoteFuncs,\"value\":_vm.editData}})],1)}\nvar staticRenderFns = []\nvar esExports = { render: render, staticRenderFns: staticRenderFns }\nexport default esExports\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/vue-loader/lib/template-compiler?{\"id\":\"data-v-b5c8d6dc\",\"hasScoped\":false,\"transformToRequire\":{\"video\":[\"src\",\"poster\"],\"source\":\"src\",\"img\":\"src\",\"image\":\"xlink:href\"},\"buble\":{\"transforms\":{}}}!./node_modules/vue-loader/lib/selector.js?type=template&index=0!./src/components/ContractMilestone/ContractMilestone.vue\n// module id = null\n// module chunks = ","var normalizeComponent = require(\"!../../../node_modules/vue-loader/lib/component-normalizer\")\n/* script */\nexport * from \"!!babel-loader!../../../node_modules/vue-loader/lib/selector?type=script&index=0!./ContractMilestone.vue\"\nimport __vue_script__ from \"!!babel-loader!../../../node_modules/vue-loader/lib/selector?type=script&index=0!./ContractMilestone.vue\"\n/* template */\nimport __vue_template__ from \"!!../../../node_modules/vue-loader/lib/template-compiler/index?{\\\"id\\\":\\\"data-v-b5c8d6dc\\\",\\\"hasScoped\\\":false,\\\"transformToRequire\\\":{\\\"video\\\":[\\\"src\\\",\\\"poster\\\"],\\\"source\\\":\\\"src\\\",\\\"img\\\":\\\"src\\\",\\\"image\\\":\\\"xlink:href\\\"},\\\"buble\\\":{\\\"transforms\\\":{}}}!../../../node_modules/vue-loader/lib/selector?type=template&index=0!./ContractMilestone.vue\"\n/* template functional */\nvar __vue_template_functional__ = false\n/* styles */\nvar __vue_styles__ = null\n/* scopeId */\nvar __vue_scopeId__ = null\n/* moduleIdentifier (server only) */\nvar __vue_module_identifier__ = null\nvar Component = normalizeComponent(\n  __vue_script__,\n  __vue_template__,\n  __vue_template_functional__,\n  __vue_styles__,\n  __vue_scopeId__,\n  __vue_module_identifier__\n)\n\nexport default Component.exports\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/components/ContractMilestone/ContractMilestone.vue\n// module id = null\n// module chunks = "],"sourceRoot":""}